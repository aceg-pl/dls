<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Deals by Seller</title>

<style>
body{margin:0;font-family:-apple-system,system-ui,Arial;background:#f5f6f7}
h1{text-align:center;padding:12px}

#controls{text-align:center;padding:6px}
.toggle{
  display:inline-block;margin:4px;padding:6px 10px;
  border-radius:999px;background:#e5e7eb;
  cursor:pointer;font-size:18px
}
.toggle.off{opacity:.3}

#feed{max-width:1000px;margin:auto;padding:8px}
.sellerBlock{margin-bottom:18px;background:#e5e7eb;border-radius:12px;padding:8px}
.sellerTitle{font-weight:700;font-size:18px;padding:6px 10px}

.item{display:flex;gap:12px;background:#fff;border-radius:10px;padding:10px;margin:8px;
  box-shadow:0 2px 5px rgba(0,0,0,.06)}
.item.hidden{display:none}

.thumb{width:90px;height:90px;object-fit:cover;border-radius:8px;flex-shrink:0}
.meta{flex:1}
.title{font-weight:600;text-decoration:none;color:#111}
.desc{font-size:14px;color:#555;margin-top:4px}
.date{font-size:12px;color:#888;margin-top:6px}
</style>
</head>

<body>
<h1>ðŸ›’ Deals grouped by seller</h1>
<div id="controls"></div>
<div id="feed"></div>

<script>
const feeds=[
  'https://www.pepper.pl/rss/wszystkie',
  'https://www.mydealz.de/rss/alles',
  'https://www.hotukdeals.com/rss/new',
  'https://www.dealabs.com/rss/tous',
  'https://www.chollometro.com/rss/nuevos'
];

const feedFlags={
  'pepper.pl':'ðŸ‡µðŸ‡±',
  'mydealz.de':'ðŸ‡©ðŸ‡ª',
  'hotukdeals.com':'ðŸ‡¬ðŸ‡§',
  'dealabs.com':'ðŸ‡«ðŸ‡·',
  'chollometro.com':'ðŸ‡ªðŸ‡¸'
};

const proxy=u=>'https://api.allorigins.win/raw?url='+encodeURIComponent(u);
const feedEl=document.getElementById('feed');
const ctrlEl=document.getElementById('controls');
let activeFlags={};

const clean=t=>t.replace(/<[^>]*>/g,'').trim();
const truncate=t=>{
  let w=clean(t).split(/\s+/);
  return w.slice(0,15).join(' ')+(w.length>15?'â€¦':'');
};
const getSeller=d=>{
  let m=d.match(/[-â€“]\s*([A-Z0-9][A-Za-z0-9 &.'-]+)/);
  return m?m[1].trim():'Other';
};
const getFlag=u=>{
  for(let k in feedFlags) if(u.includes(k)) return feedFlags[k];
  return 'ðŸŒ';
};

function applyFilter(){
  document.querySelectorAll('.item').forEach(i=>{
    i.classList.toggle('hidden',!activeFlags[i.dataset.flag]);
  });
  document.querySelectorAll('.sellerBlock').forEach(b=>{
    b.style.display=[...b.querySelectorAll('.item')]
      .some(i=>!i.classList.contains('hidden'))?'':'none';
  });
}

Promise.all(
  feeds.map(f=>
    fetch(proxy(f))
      .then(r=>r.text())
      .then(t=>({src:f,xml:t}))
      .catch(()=>null)
  )
).then(all=>{
  let sellers={}, flags=new Set();

  all.filter(Boolean).forEach(({src,xml})=>{
    let doc=new DOMParser().parseFromString(xml,'text/xml');
    doc.querySelectorAll('item').forEach(i=>{
      let desc=i.querySelector('description')?.textContent||'';
      let flag=getFlag(src);
      flags.add(flag);

      let img=
        i.querySelector('media\\:thumbnail,thumbnail')?.getAttribute('url')||
        (desc.match(/img.*?src="(.*?)"/i)||[])[1]||
        '';

      let d={
        title:i.querySelector('title')?.textContent||'',
        link:i.querySelector('link')?.textContent||'',
        desc,
        img,
        date:new Date(i.querySelector('pubDate')?.textContent||0),
        flag
      };

      let seller=getSeller(desc);
      (sellers[seller]=sellers[seller]||[]).push(d);
    });
  });

  flags.forEach(f=>{
    activeFlags[f]=true;
    ctrlEl.insertAdjacentHTML('beforeend',
      `<span class="toggle" data-flag="${f}">${f}</span>`
    );
  });

  ctrlEl.onclick=e=>{
    let t=e.target.closest('.toggle');
    if(!t)return;
    let f=t.dataset.flag;
    activeFlags[f]=!activeFlags[f];
    t.classList.toggle('off',!activeFlags[f]);
    applyFilter();
  };

  Object.entries(sellers)
    .sort((a,b)=>Math.max(...b[1].map(x=>x.date))-Math.max(...a[1].map(x=>x.date)))
    .forEach(([seller,deals])=>{
      deals.sort((a,b)=>b.date-a.date);
      let f=[...new Set(deals.map(d=>d.flag))].join(' ');
      feedEl.insertAdjacentHTML('beforeend',`
        <div class="sellerBlock">
          <div class="sellerTitle">${seller} ${f} (${deals.length})</div>
          ${deals.map(d=>`
            <div class="item" data-flag="${d.flag}">
              <img class="thumb" src="${d.img||'https://via.placeholder.com/90'}">
              <div class="meta">
                <a class="title" href="${d.link}" target="_blank">
                  ${d.flag} ${d.title}
                </a>
                <div class="desc">${truncate(d.desc)}</div>
                <div class="date">${d.date.toLocaleString()}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `);
    });
});
</script>
</body>
</html>
